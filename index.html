<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <style>
        /* 1. Reset CSS */
        * { box-sizing: border-box; touch-action: none; /* Ù„Ù…Ù†Ø¹ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */ }

        body {
            background-color: #2b2b2b;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø¨Ø§Ø± ÙÙˆÙ‚ ÙˆØ§Ù„ÙƒØªØ§Ø¨ ØªØ­Øª */
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* 2. Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ */
        #toolbar {
            height: 60px;
            background: #1a1a1a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .tool-group { display: flex; gap: 10px; }

        button {
            background: #444;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        button.active { background: #007bff; font-weight: bold; }
        button:active { transform: scale(0.95); }

        /* 3. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØªØ§Ø¨ */
        #book-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: calc(100vh - 60px);
            padding: 10px;
        }

        .my-page {
            background-color: #fdfdfd;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="tool-group">
            <button id="btn-read" class="active" onclick="setMode('read')">ğŸ“– Ù‚Ø±Ø§Ø¡Ø©</button>
            <button id="btn-write" onclick="setMode('write')">âœï¸ ÙƒØªØ§Ø¨Ø©</button>
        </div>
        <div class="tool-group">
            <button onclick="clearCurrentPage()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        </div>
    </div>

    <div id="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨...</div>

    <div id="book-wrapper">
        <div id="book"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        const pdfUrl = 'my-book.pdf'; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
        const bookElement = document.getElementById('book');
        let pageFlip;
        let fabricPages = []; // Ù„ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù†Ø§Øª Fabric
        let appMode = 'read'; // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

        // 1. Ø­Ø³Ø§Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒØªØ§Ø¨ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        function calculateBookSize() {
            const wrapper = document.getElementById('book-wrapper');
            const w = wrapper.clientWidth;
            const h = wrapper.clientHeight;
            
            // Ù„Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø·ÙˆÙ„)
            if (w < 768) {
                return { width: w - 20, height: h - 20, isMobile: true };
            }
            // Ù„Ùˆ Ù„Ø§Ø¨ØªÙˆØ¨ (ØµÙØ­ØªÙŠÙ† Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶)
            return { width: 500, height: h - 40, isMobile: false };
        }

        async function startApp() {
            try {
                const size = calculateBookSize();
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ PageFlip Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
                pageFlip = new St.PageFlip(bookElement, {
                    width: size.width,
                    height: size.height,
                    size: size.isMobile ? 'fixed' : 'fixed', // ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                    showCover: true,
                    mobileScrollSupport: false // Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ¹Ø§Ø±Ø¶Ø´ Ù…Ø¹ Ø§Ù„Ø±Ø³Ù…
                });

                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                document.getElementById('loader').style.display = 'none';

                // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                for (let i = 1; i <= pdf.numPages; i++) {
                    const div = document.createElement('div');
                    div.className = 'my-page';
                    div.innerHTML = `<canvas id="f-canvas-${i}"></canvas>`;
                    bookElement.appendChild(div);
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª ÙÙŠ PageFlip
                pageFlip.loadFromHTML(document.querySelectorAll('.my-page'));

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ ØµÙØ­Ø© ÙˆÙˆØ¶Ø¹ Fabric Ø¹Ù„ÙŠÙ‡Ø§
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const canvasId = `f-canvas-${i}`;
                    
                    // Ù†Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù†ÙØ³ Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø© ÙÙŠ PageFlip
                    const fCanvas = new fabric.Canvas(canvasId, {
                        width: size.width,
                        height: size.height,
                        selection: false // ØªØ¹Ø·ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                    });

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ Scale Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù€ PDF Ø¹Ø´Ø§Ù† ÙŠÙ…Ù„Ø£ Ø§Ù„ØµÙØ­Ø©
                    const unscaledViewport = page.getViewport({ scale: 1 });
                    const scaleX = size.width / unscaledViewport.width;
                    const scaleY = size.height / unscaledViewport.height;
                    // Ù†Ø®ØªØ§Ø± Ø§Ù„Ù€ Scale Ø§Ù„Ø£Ù†Ø³Ø¨ Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…ØªØªÙ…Ø·Ø´
                    const scale = Math.min(scaleX, scaleY); 
                    const viewport = page.getViewport({ scale: scale });

                    // Ø±Ø³Ù… Ø§Ù„Ù€ PDF ÙÙŠ Memory Canvas
                    const hiddenCanvas = document.createElement('canvas');
                    hiddenCanvas.width = viewport.width;
                    hiddenCanvas.height = viewport.height;
                    const ctx = hiddenCanvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    // ÙˆØ¶Ø¹Ù‡ ÙƒØ®Ù„ÙÙŠØ© Ù„Ù€ Fabric
                    const imgData = hiddenCanvas.toDataURL();
                    fabric.Image.fromURL(imgData, function(img) {
                        // ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                        fCanvas.setBackgroundImage(img, fCanvas.renderAll.bind(fCanvas), {
                            originX: 'center',
                            originY: 'center',
                            left: size.width / 2,
                            top: size.height / 2
                        });
                    });

                    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ø´Ø§Ø©
                    fCanvas.freeDrawingBrush.width = 5;
                    fCanvas.freeDrawingBrush.color = "rgba(255, 235, 59, 0.6)"; // Ù‚Ù„Ù… ØªØ­Ø¯ÙŠØ¯ Ø£ØµÙØ±
                    fCanvas.isDrawingMode = false; // Ù†Ø¨Ø¯Ø£ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©

                    fabricPages.push(fCanvas);
                }

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: " + err.message;
            }
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ (Ù‚Ø±Ø§Ø¡Ø© / ÙƒØªØ§Ø¨Ø©) ---
        
        window.setMode = function(mode) {
            appMode = mode;
            
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ±
            document.getElementById('btn-read').className = mode === 'read' ? 'active' : '';
            document.getElementById('btn-write').className = mode === 'write' ? 'active' : '';

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
            fabricPages.forEach(canvas => {
                if (mode === 'write') {
                    canvas.isDrawingMode = true;
                    // Ù‡Ù†Ø§ Ø§Ù„ØªØ±ÙŠÙƒ: Ù„Ù…Ø§ Ù†ÙƒÙˆÙ† Ø¨Ù†ÙƒØªØ¨ØŒ Ù†ÙˆÙ‚Ù ØªÙ‚Ù„ÙŠØ¨ Ø§Ù„ØµÙØ­Ø©
                    // Ù…ÙƒØªØ¨Ø© pageFlip Ù…ÙÙŠÙ‡Ø§Ø´ stop Ù…Ø¨Ø§Ø´Ø± Ø³Ù‡Ù„ØŒ Ø¨Ø³ Ù…Ù…ÙƒÙ† Ù†ØªØ­Ø§ÙŠÙ„ Ø¹Ù„ÙŠÙ‡Ø§
                    // Ù„ÙƒÙ† Fabric Ø¨ÙŠØ§Ø®Ø¯ Ø§Ù„Ù€ Touch Event Ø§Ù„Ø£ÙˆÙ„ ÙØ§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£Ù…Ø§Ù†
                } else {
                    canvas.isDrawingMode = false;
                }
            });
        };

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        window.clearCurrentPage = function() {
            // Ù†Ø¹Ø±Ù Ø¥Ø­Ù†Ø§ ÙÙŠ ØµÙØ­Ø© ÙƒØ§Ù…
            const currentPageIndex = pageFlip.getCurrentPageIndex();
            // Ø¨Ù…Ø§ Ø£Ù† pageFlip Ø¨ÙŠØ­Ø³Ø¨ Ø§Ù„Ù€ Index Ù…Ù† 0
            // ÙˆÙ…ØµÙÙˆÙØ© fabricPages Ø¨ØªØ§Ø¹ØªÙ†Ø§ Ù…ØªØ±ØªØ¨Ø© Ù†ÙØ³ Ø§Ù„ØªØ±ØªÙŠØ¨
            const currentCanvas = fabricPages[currentPageIndex];
            
            if(currentCanvas) {
                // Ù†Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©
                currentCanvas.getObjects().forEach(obj => {
                    currentCanvas.remove(obj);
                });
            }
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        startApp();

        // ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© (Ù„Ø£Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù‚Ø¯Ø© Ø´ÙˆÙŠØ©)
        window.addEventListener('resize', () => {
            // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¨Ù†Ø¹Ù…Ù„ reload Ø£Ùˆ re-init
            // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† Ù†ÙƒØªÙÙŠ Ø¨ØªÙ†Ø¨ÙŠÙ‡ Ø£Ùˆ ØªØ¬Ø§Ù‡Ù„ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
        });

    </script>
</body>
</html>